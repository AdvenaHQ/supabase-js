import"server-only";import{Redis as p}from"@upstash/redis";import{Md5 as d}from"ts-md5";import{log as s}from"../../helpers/log";import{globalOptions as a}from"../index";const f={"/realtime/":{cache:!1,expireSetAfter:void 0},"/auth/":{cache:!0,expireSetAfter:60},"/storage/":{cache:!1,expireSetAfter:void 0},"/functions/":{cache:!0,expireSetAfter:30},"/rest/":{cache:!0,expireSetAfter:900}},y=async(o,r)=>{if(a?.cache?.provider!=="upstash-redis")return s("\u26A0\uFE0F The cache provider is not configured for Upstash Redis. Please check the configuration. Falling back to default fetch.","warn",!0),fetch(o,r);const c=new p({url:a.cache?.upstash?.url,token:a.cache?.upstash?.token}),t={url:new URL(o),method:r?.method||"GET",headers:new Headers(r?.headers)},h=`/${t.url.pathname.split("/")[1]}/`;if(t.method==="GET"&&f[h]?.cache)try{const e=d.hashStr(t.url.toString()),n=await c.get(e);if(n)return s(`\u{1F3AF} Cache HIT for key \`${e}\` (${t.url.toString()})`,"debug"),new Response(JSON.stringify(n));s(`\u{1F93A} Cache MISS for key \`${e}\` (${t.url.toString()})`,"debug");const i=await fetch(o,r),u=await i.clone().text();return await c.set(e,u,{ex:a?.cache?.upstash?.behaviour?.expireSetAfter||f[h]?.expireSetAfter||60}),i}catch(e){s(`Error fetching data from Upstash Redis: ${e}`,"error",!0)}return fetch(o,r)};export{y as UpstashCacheProviderFetch};
//# sourceMappingURL=upstash.js.map
